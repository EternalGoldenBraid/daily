{% extends "layout.html" %}

{% block title %}
	Daily

{% endblock %}

{% block main %}

	{% block content %}
		<h1> Hi, {{ current_user.username }}!</h1>
		
	{% endblock %}

 <table class="table">
  <thead class=.thead-dark>
    <tr>
      <th scope="col">Date</th>
      <th scope="col">Sleep</th>
      <th scope="col">Meditation</th>
      <th scope="col">Description</th>
      <th scope="col">Screens</th>
      <th scope="col">Rating</th>
      <th scope="col">Creative Work</th>
    </tr>
  </thead>
  <tbody>
	  <!-- Render per date in ratings table, join event_date==rating_date -->
		{% for i in rating%}
			<tr>
				<td scope="data"> {{i.date.strftime('%Y-%m-%d')}}</td>
				<td scope="data"> {{i.rating_sleep}}</td>
				<td scope="data"> {{i.meditation}}</td>
				<td scope="data">
					{% for r in rating_event %}
						{% if i.date==r.Event.rating_date %}
							{{r.Event.event_tag}}:{{r.Event.duration}},
						{% endif %}
					{% endfor %}
				</td>
				<td scope="data"> {{i.screen.strftime('%H:%M')}}</td>
				<td scope="data"> {{i.rating_day}}</td>
				<td scope="data"> {{i.cw}}</td>
    	</tr>             
		{% endfor %}
  </tbody>
</table>

<div class="form-container">
<h2> How was your day? </h2>

<div class="form-row">
  <form class= "form" "form-horizontal" action="" method="post" >
    {{ form_day.hidden_tag() }}
    <p>
	{{ form_day.date.label }} 
  {{ form_day.date(class="form-control", type="date", size=12) }}

	{{ form_day.sleep_rating.label }} 
  {{ form_day.sleep_rating(size=3) }}

	{{ form_day.meditation.label }} 
	{{ form_day.meditation(class="form-control", type="time", size=7) }} 

	{{ form_day.day_rating.label }} <br> 
	{{ form_day.day_rating(size=6) }} 

	{{ form_day.lights.label }} 
	{{ form_day.lights(class="form-control", type="time", size=5) }} 

	{{ form_day.cw.label }}
	{{ form_day.cw(class="form-control", type="time", size=12) }} 
    </p>
		<p> {{ form_day.submit() }} </p>
</div>


  <div class="form-row">
    {{ form_events.hidden_tag() }}
		{{ form_events.event(size=20) }}
		{{ form_events.duration_event(class="form-control",
				type="time", size=20) }}
  <p> <input id="eventsubmits" name="submit" type="submit" 
                value="Submit Events"> </p>
  </div>
<span id = result>"confirm"</span>


<!-- Append event:duration pairs while submitting data -->
<script type=text/javascript>
  $(function() {
    $('#eventsubmits').bind('click', function(event) {
			event.preventDefault();
			let ev = $('input[name="event"]').val();
			let dr = $('input[name="duration_event"]').val();
      let description={"event": ev, "duration": dr};
			
			// For debugging
			console.log("In JSobject: ", description);
			console.log("In json: ", JSON.stringify(description));

      $.post($SCRIPT_ROOT + '/events_confirm', {
				event: ev,
				duration: dr 
      }).done(function(response) {

				// Testing
				$('#result').text(response);
				for (let [key, value] of Object.entries(response)) {
					console.log(`${key}: ${value}`)
				};

				// Generate table based on response
        function generateTableHead(table, keys) {
            let thead = table.createTHead();
            let row = thead.insertRow();
						var labels = ['Event', 'Duration']
					
					// Debug
					console.log("Thead return: ", thead)
					console.log("row return: ", row)

            for (let label of labels) {
								let th = document.createElement("th");
								let text = document.createTextNode(label);
								th.appendChild(text);
								row.appendChild(th);
          }
        }

				function generateTable(table, data) {

					for(let entry of Object.entries(data)) {
						let row = table.insertRow();
						for(let item of entry) {
							let cell =row.insertCell();
							let text = document.createTextNode(item);
							cell.appendChild(text);
						}
					}
				}
        let table = document.querySelector("#confirmevents");
        let keys= Object.keys(response);
				generateTableHead(table, keys);
				generateTable(table, response);

				// Debug
				console.log("Table element: ", table);
				console.log("Keys: ", keys);
				console.error(error);

			}).fail(function() {

				// Debug
				console.log("Error: scripts 127 index.html");
			});
    });
  });

</script>


<!-- Table generated from response -->
<body>
<table id="confirmevents" class= "">

	</table>
	</body>
        
{% endblock %}

 <table class="table table-sm">
  <thead class=.thead-dark>
    <tr>
      <th scope="col">Event</th>
      <th scope="col">Duration</th>
    </tr>
  </thead>
  <tbody>
	  <!-- Render per date in ratings table, join event_date==rating_date -->
		{% for entry in event%}
			<tr>
				<td scope="data"> {{ event }}</td>
				<td scope="data"> {{ duration }}</td>
    	</tr>             
		{% endfor %}
  </tbody>
</table>
